FROM flecsi/flecsi-buildenv:fedora

ARG METIS_INT64

COPY flecsi-third-party/ /home/flecsi/tpl
COPY ccache/ /home/flecsi/.ccache
USER root
RUN chown -R flecsi:flecsi /home/flecsi/tpl /home/flecsi/.ccache
USER flecsi

WORKDIR /home/flecsi/tpl
RUN ccache -z
RUN mkdir -p build && cd build && \
    cmake -DBUILD_SHARED_LIBS=ON \
          -DENABLE_EXODUS=ON -DENABLE_LAPACK=ON \
          -DENABLE_METIS=ON  -DENABLE_SCOTCH=ON \
          -DENABLE_CINCH_UTILS=ON \
          -DENABLE_CEREAL=ON \
          -DENABLE_LEGION=ON -DCMAKE_INSTALL_PREFIX=$HOME/tpl \
          -DMETIS_INT64=${METIS_INT64} .. && make -j2;
RUN ccache -s

# Build FleCSI if it is not for DockerHub and master branch
WORKDIR /home/flecsi
RUN git clone --recursive https://github.com/losalamos/flecsi flecsi && \
    cd flecsi && mkdir build && cd build && \
    cmake -DCMAKE_PREFIX_PATH=$HOME/tpl -DENABLE_PARTITION=ON -DENABLE_IO=ON \
         -DENABLE_UNIT_TESTS=ON -DFLECSI_RUNTIME_MODEL=legion .. && \
    make -j2 && make test && \
    cd ../.. && \
    rm -rf flecsi;
